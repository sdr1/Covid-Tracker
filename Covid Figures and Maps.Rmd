---
title: "Covid Figures and Maps"
author: "Steven Rashin"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F,cache = F, message = F)
library(usmap)
library(ggplot2)
library(tidyverse)
library(dplyr)
library(data.table)
library(tidyr)
library(lubridate)
library(tigris)
library(dslabs)
library(grid)
library(gridExtra)
library(cowplot)
library(plotly)

setwd("/Users/stevenrashin/Dropbox/covid data/")

### CDC linked data ###
CDC_cases <- fread('https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_confirmed_usafacts.csv')
CDC_deaths <- fread('https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_deaths_usafacts.csv')

### Population Data ###
population_data <- fread("https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_county_population_usafacts.csv")

population_data_by_state <- population_data %>%
  group_by(State) %>%
  summarize(population = sum(population,na.rm = T))

#CDC_deaths_by_race_and_state <- fread('https://data.cdc.gov/api/views/ks3g-spdg/rows.csv?accessType=DOWNLOAD')

### Reshape data to long, tidyreshape is easy so use that! ###
long_cases <- pivot_longer(CDC_cases, cols=5:length(CDC_cases), names_to = "Date", values_to = "Cases")
long_cases$Date <- lubridate::mdy(long_cases$Date)

long_deaths <- pivot_longer(CDC_deaths, cols=5:length(CDC_deaths), names_to = "Date", values_to = "Deaths")
long_deaths$Date <- lubridate::mdy(long_deaths$Date)
long_deaths$`County Name` <- NULL

#check for duplicates, none found but worth checking
# any_dupes_CDC_cases <- c(paste0(long_cases$countyFIPS, long_cases$State, long_cases$stateFIPS, long_cases$Date))
# which(duplicated(any_dupes_CDC_cases))
# 
# any_dupes_CDC_deaths <- c(paste0(long_deaths$countyFIPS, long_deaths$State, long_deaths$stateFIPS, long_deaths$Date))
# which(duplicated(any_dupes_CDC_deaths))

CDC_total <- merge(long_cases, long_deaths, by = c("countyFIPS" ,"State","stateFIPS","Date"))

CDC_total <- CDC_total %>% 
  mutate(Week = lubridate::week(Date),
         Day = lubridate::yday(Date),
         Month = lubridate::month(Date))

rm(CDC_cases, CDC_deaths, long_cases, long_deaths)

### COVID tracking data from https://covidtracking.com/data/download ###
#confirmed_cases_covid_tracker <- fread("https://covidtracking.com/api/v1/us/daily.csv")
covid_tracking_data <- fread("https://covidtracking.com/api/v1/states/daily.csv")

#Rename variables as necessary to make it easy to compare between data sets
covid_tracking_data$Date <- lubridate::ymd(covid_tracking_data$date)
covid_tracking_data$State <- covid_tracking_data$state

#### Plot New Cases BY STATE with week long kernal smoother ####
# trend line modified from https://rafalab.github.io/dsbook/smoothing.html
# note that kernl = normal prodices better plots than kernel = box as some states (e.g. MS) don't produce data
# for days at a time and normal smooths this out more than box
# also, if you want to do loess, use the following code loess(new_cases ~ Day, degree=1, span = 14)$y
# for a one week average, the normal kernel does better than a loess

CDC_w_trendline <- CDC_total %>% 
  #filter(State == "MA") %>%
  group_by(State, stateFIPS, Date, Day, Week) %>%
  arrange(State, Date, countyFIPS) %>%
  summarise(total_cases_by_day = sum(Cases),
            total_deaths_by_day = sum(Deaths)) %>%
  ungroup() %>% 
  group_by(State) %>%
  mutate(new_cases = total_cases_by_day - dplyr::lag(total_cases_by_day, default = 0),
         new_deaths = total_deaths_by_day - dplyr::lag(total_deaths_by_day, default = 0)) %>%
  mutate( smooth_new_cases = ksmooth(Day, new_cases, kernel = "normal", bandwidth = 7)$y,
          smooth_total_cases = ksmooth(Day, total_cases_by_day, kernel = "normal", bandwidth = 7)$y,
          smooth_deaths = ksmooth(Day, new_deaths, kernel = "normal", bandwidth = 7)$y,
          smooth_total_deaths = ksmooth(Day, total_deaths_by_day, kernel = "normal", bandwidth = 7)$y)  %>%
  ungroup() 

covid_tracking_data_w_trendline <- covid_tracking_data %>% filter(State %in% state.abb) %>%
  mutate(Week = lubridate::week(Date),
         Day = lubridate::yday(Date)) %>%
  arrange(State, Date)  %>% 
  group_by(State) %>%
  mutate( smooth_new_cases = ksmooth(Day, positiveIncrease, kernel = "normal", bandwidth = 7)$y,
          smooth_total_cases = ksmooth(Day, positive, kernel = "normal", bandwidth = 7)$y,
          smooth_deaths = ksmooth(Day, deathIncrease, kernel = "normal", bandwidth = 7)$y,
          smooth_total_deaths = ksmooth(Day, death, kernel = "normal", bandwidth = 7)$y) %>%
  ungroup() 


NE.abrv <- c("CT","ME","MA","NH","RI","VT","NJ","NY","PA")
MW.abrv <- c("IN","IL","MI","OH","WI","IA","KS","MN","MO","NE",
             "ND","SD")
S.abrv <- c("DE","DC","FL","GA","MD","NC","SC","VA","WV","AL",
            "KY","MS","TN","AR","LA","OK","TX")
W.abrv <- c("AZ","CO","ID","NM","MT","UT","NV","WY","AK","CA",
            "HI","OR","WA")
region.list <- list(
  Northeast=NE.abrv,
  Midwest=MW.abrv,
  South=S.abrv,
  West=W.abrv)

CDC_w_trendline$Region <- sapply(CDC_w_trendline$State, function(x) names(region.list)[grep(x,region.list)])

```

## Data Sources

Data for this report comes from:

* The CDC Homepage <https://www.cdc.gov/covid-data-tracker/index.html#county-map> and <https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/>, specifically:
    + Confirmed COVID Cases <https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_confirmed_usafacts.csv>
    + Covid Deaths <https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_deaths_usafacts.csv>
    + County Population <https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_county_population_usafacts.csv>
* Covidtracker.com data (used by Johns Hopkins <https://coronavirus.jhu.edu/us-map>) <https://covidtracking.com/api/v1/states/daily.csv>
* World Health Organization <https://covid19.who.int/>
* Somerville City data <https://somerville-dashboardcovid.trial.opendatasoft.com/pages/citysdashboard/>

## Headline Numbers 
As of `r format(max(CDC_w_trendline$Date), '%B %d, %Y')`:  

* `r formatC(CDC_w_trendline %>% filter(Date == max(Date)) %>% ungroup() %>% summarize(sum(new_cases)) %>% pull(), format="f", big.mark=",", digits=0)` new cases.
  + The record number of cases per day is `r formatC(CDC_w_trendline %>% group_by(Date) %>% summarize(new_cases = sum(new_cases)) %>% filter(new_cases == max(new_cases)) %>% select(new_cases) %>% pull(), format="f", big.mark=",", digits=0)` on `r format(CDC_w_trendline %>% group_by(Date) %>% summarize(new_cases = sum(new_cases)) %>% filter(new_cases == max(new_cases)) %>% select(Date) %>% pull(), '%B %d, %Y')`
* `r formatC(CDC_w_trendline %>% filter(Date == max(Date)) %>% ungroup() %>% summarize(sum(new_deaths)) %>% pull(), format="f", big.mark=",", digits=0)` new deaths
  +  The record number of deaths per day is `r formatC(CDC_w_trendline %>% group_by(Date) %>% summarize(new_deaths = sum(new_deaths)) %>% filter(new_deaths == max(new_deaths)) %>% select(new_deaths) %>% pull(), format="f", big.mark=",", digits=0)` on `r format(CDC_w_trendline %>% group_by(Date) %>% summarize(new_deaths = sum(new_deaths)) %>% filter(new_deaths == max(new_deaths)) %>% select(Date) %>% pull(), '%B %d, %Y')`

Consequently there are now:   

* `r formatC(CDC_w_trendline %>% ungroup() %>% summarize(sum(new_cases)) %>% pull(), format="f", big.mark=",", digits=0)` total cases  
* `r formatC(CDC_w_trendline %>% ungroup() %>% summarize(sum(new_deaths)) %>% pull(), format="f", big.mark=",", digits=0)` total deaths  

## Overall Covid Cases In The USA

Regions are defined as follows: Northeast (CT, ME, MA, NH, RI, VT, NJ, NY, PA), Midwest (IN, IL, MI, OH, WI, IA, KS, MN, MO, NE, ND, SD), South (AL, AR, DC, DE, FL, GA, KY, LA, MD, MS, NC, OK, SC, TN, TX, VA, WV) and West (AZ, CO, ID,  NM, MT, UT, NV, WY,AK,CA,HI,OR,WA).

```{r cars, echo = F, warning = F,cache = F, message = F,fig.width = 11, fig.height = 8.5}

New_Cases <- CDC_w_trendline %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date, Region) %>%
  summarize(new_cases = sum(new_cases)) %>%
  ggplot(aes(x = Date, y = new_cases, fill = Region)) +
  geom_area() +
  theme_minimal() +
  scale_fill_brewer() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Cases") + 
  ggtitle(c(paste("New Cases: CDC Data As Of", as.Date(max(CDC_w_trendline$Date))))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold"),
    legend.position = "none"
  )

New_Deaths <- CDC_w_trendline %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date, Region) %>%
  summarize(new_deaths = sum(new_deaths)) %>%
  ggplot(aes(x = Date, y = new_deaths, fill = Region)) +
  geom_area() +
  theme_minimal() +
  scale_fill_brewer() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Deaths") + 
  ggtitle(c(paste("Deaths Per Day"))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold"),
    legend.position = "none"
  )

CDC_cases <- CDC_w_trendline %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date, Region) %>%
  summarise(`Cumulative Cases` = sum(total_cases_by_day),
            total_deaths_by_day = sum(total_deaths_by_day)) %>%
  ggplot(aes(x = Date, y = `Cumulative Cases`, fill = Region)) +
  geom_area() +
  theme_minimal() +
  scale_fill_brewer() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Total Cases") + 
  ggtitle(c(paste("Total Cases")))+ #, as.Date(max(CDC_w_trendline$Date))))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold"),
    legend.position = "none"
  )

CDC_deaths <- CDC_w_trendline %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date, Region) %>%
  summarise(total_cases_by_day = sum(total_cases_by_day),
            `Cumulative Deaths` = sum(total_deaths_by_day)) %>%
  ggplot(aes(x = Date, y = `Cumulative Deaths`, fill = Region)) +
  geom_area() +
  theme_minimal() +
  scale_fill_brewer() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Total Deaths") + 
  ggtitle(c(paste("Total Deaths"))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )

#CDC
grid.arrange(New_Cases, CDC_cases, New_Deaths, CDC_deaths, nrow = 2, ncol = 2)

# a <- list(
#   text = c(paste("Total Cases To", as.Date(max(CDC_w_trendline$Date)))),
#   xref = "paper",
#   yref = "paper",
#   yanchor = "bottom",
#   xanchor = "center",
#   align = "center",
#   x = 0.5,
#   y = 1,
#   showarrow = FALSE
# )
# 
# b <- list(
#   text = "Total Deaths",
#   xref = "paper",
#   yref = "paper",
#   yanchor = "bottom",
#   xanchor = "center",
#   align = "center",
#   x = 0.5,
#   y = 1,
#   showarrow = FALSE
# )
# 
# subplot(style(ggplotly(CDC_cases)  %>% layout(annotations = a), showlegend = F), 
#         style(ggplotly(CDC_deaths)  %>% layout(annotations = b), showlegend = T),nrows = 1)

```

## US Cases Compared to World Cases
```{r US v World, echo = F, warning = F,cache = F, message = F,fig.width = 11, fig.height = 8.5}

try_url <- function(url){
      tryCatch(
        expr = {
          local <- fread(url)
          return(local)
        },
        error = function(e){
            message('"ERROR Out of Date Data / Using Last Saved DATA"')
            global <- read.csv("/Users/stevenrashin/Documents/GitHub/Covid-Tracker/WHO-COVID-19-global-data.csv",stringsAsFactors = F)
            return(local)
        }
    )
}

global <- try_url("https://covid19.who.int/WHO-COVID-19-global-data.csv")

global$Date <- lubridate::ymd(gsub(pattern = "T.{1,}$", replacement = "", x = global$Date_reported))
global %>% 
    mutate(
         Day = lubridate::yday(Date),
         Week = lubridate::week(Date),
         Country = ifelse(Country_code == "US", "USA", "Non-US"),
         Country = ifelse(is.na(Country), "Non-US", Country)) %>%
  group_by(Country, Date, Day, Week) %>%
   summarise(Cumulative_cases = sum(Cumulative_cases, na.rm = T),
             New_cases = sum(New_cases, na.rm = T)) %>%
    ggplot(aes(x = Date, y = Cumulative_cases, fill = Country)) +
  geom_area() +
  theme_minimal() +
  scale_fill_brewer() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Cases") + 
  ggtitle(c(paste("US Cases Compared To World Cases"))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )

  
  # 
  # 
  # facet_wrap(~ Country) +
  # #ggtitle(c(paste("New Cases Up To", max(global$Date)))) +
  # xlab("Date") + ylab("New Cases Per Day") +
  # theme(
  #   plot.title = element_text(size=14, face="bold",hjust = 0.5),
  #   axis.title.x = element_text(size=14, face="bold"),
  #   axis.title.y = element_text(size=14, face="bold"),
  #   strip.text.x = element_text(size=10, face="bold"),
  #   axis.text = element_text(size=14, face="bold")
  # )


```

## Covid Cases in Somerville, MA in the Last Two Weeks
```{r Somerville, echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# from https://somerville-dashboardcovid.trial.opendatasoft.com/explore/dataset/daily-c19-case-counts/information/


try_url <- function(url){
      tryCatch(
        expr = {
          local <- fread(url)
          return(local)
        },
        error = function(e){
            message('"ERROR Out of Date Data / Using Last Saved DATA"')
            local <- read.csv("/Users/stevenrashin/Documents/GitHub/Covid-Tracker/daily-c19-case-counts.csv",stringsAsFactors = F)
            return(local)
        }
    )
}

local <- try_url("https://somerville-dashboardcovid.trial.opendatasoft.com/explore/dataset/daily-c19-case-counts/download/?format=csv&timezone=America/New_York&lang=en&use_labels_for_header=true&csv_separator=%2C")

local$Date <- lubridate::ymd(gsub(pattern = "T.{1,}$", replacement = "", x = local$Date))
local %>% 
    mutate(new_cases = Positive - dplyr::lag(Positive, default = 0),
         new_deaths = Fatalities - dplyr::lag(Fatalities, default = 0),
         Day = lubridate::yday(Date),
         Week = lubridate::week(Date)) %>%
    mutate( smooth_new_cases = ksmooth(Day, new_cases, kernel = "normal", bandwidth = 7)$y) %>%
  filter(Week %in% c(max(Week), max(Week)-1)) %>%
  ggplot(aes(x = Date, y = new_cases)) +
  geom_point(size = 3, alpha = 1) + 
  geom_line(aes(Date, smooth_new_cases), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  theme_minimal() + ggtitle(c(paste("Cases Up To", max(local$Date)))) +
  xlab("Date") + ylab("New Cases Per Day") +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )
```

## Covid Cases in MA in the Last Two Weeks 
```{r MA Cases,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# New cases by state by day, log scale, with week long trend line
# use log scale otherwhise NY and MA overwhelm other states
CDC_w_trendline %>% filter(State == "MA" & Week %in% c(max(Week), max(Week)-1)) %>%
  ggplot(aes(x = Date, y = new_cases)) +
  geom_point(size = 3, alpha = 1) + 
  geom_line(aes(Date, smooth_new_cases), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  theme_minimal() +
  xlab("Date") + ylab("New Cases Per Day") + ggtitle(c(paste("Cases Up To", max(CDC_w_trendline$Date)))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )
```

## Latest Cases in Boston Area

```{r MA Local,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}

Latest_Near_Me <- 
CDC_total %>% filter(countyFIPS %in% c(25017,25021, 25025) & 
                       Week %in% c((max(Week)-3):max(Week) )) %>% 
  ungroup () %>%
  group_by(countyFIPS) %>%
  arrange(Date) %>%
  mutate(`New Cases` = Cases - dplyr::lag(Cases, default = 0),
         `New Deaths` = Deaths - dplyr::lag(Deaths, default = 0)) %>% 
  filter(Date %in% c((max(Date)-7):max(Date) )) %>%
  arrange(`County Name`, desc(Date)) %>% 
  ungroup() 

knitr::kable(Latest_Near_Me %>% select(Date,`County Name`, Cases, Deaths, `New Cases`, `New Deaths`)) 

```

## New Covid Cases By State: Log Scale Cases

```{r,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# New cases by state by day, log scale, with week long trend line
# use log scale otherwhise NY and MA overwhelm other states
CDC_w_trendline %>% #filter(State == "OK") %>%
  ggplot(aes(x = Date, y = new_cases)) +
  geom_point(size = 1, alpha = .5) + 
  geom_line(aes(Date, smooth_new_cases), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1),trans='log10') +
  facet_wrap(~ State) + #, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("New Cases Per Day") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")

  )
```

## Latest County Case Map
```{r,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# Overall level on the most recent day
usmap::plot_usmap("counties", labels = F, include = state.abb,
                  data = CDC_total %>% 
                    filter(countyFIPS > 10 & # & Date == max(Date),
                             State %in% state.abb &
                           Date == max(Date)) %>%
                    dplyr::rename(fips = countyFIPS, 
                                  abbr = State) %>%
                    select(fips, Date, Cases), 
                  values = "Cases") + 
  scale_fill_continuous(low = "blue", high = "red",name = "Covid Cases", label = scales::comma) + #trans = "log10",
  theme(legend.position = "right") + 
  facet_wrap(~ Date)  + 
  theme_void() + xlab("") + ylab("") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=14, face="bold"),
  )

```

## Latest County Death Map
```{r deaths_by_county,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# Overall level on the most recent day
# Deaths by county
usmap::plot_usmap("counties", labels = F, include = state.abb,
                  data = CDC_total %>% 
                    filter(countyFIPS > 10 & 
                             State %in% state.abb &
                             Date == max(Date)) %>%
                    dplyr::rename(fips = countyFIPS, 
                                  abbr = State) %>%
                    select(fips, Date, Deaths), 
                  values = "Deaths") + 
  scale_fill_continuous(low = "blue", high = "red",name = "COVID Deaths", label = scales::comma) + #trans = "log10",
  theme(legend.position = "right") + 
  theme_void() + xlab("") + ylab("") 
```


## Top 5 Counties: Today and The First of Each Month
```{r top counties,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}

# Top 5 counties by first of the month
Top5Counties <- CDC_total %>% 
  filter(countyFIPS > 10 & # & Date == max(Date),
           State %in% state.abb &
           (grepl("-01$", Date))|Date == max(Date)) %>%
  dplyr::rename(fips = countyFIPS, 
                abbr = State) %>%
  group_by(fips, Date) %>%
  group_by(Date) %>%
  arrange( -Cases) %>%
  slice(1:5) %>% 
  ungroup() %>% arrange(desc(Date))

# See top counties.  Mapping them doesn't make sense

knitr::kable(Top5Counties %>% select(Date, abbr,`County Name`, Cases, Deaths) %>% dplyr::rename(State = abbr))

```

## Total Covid Cases By State: Free Scale Cases
```{r,echo = F, warning = F,cache = F, message = F, fig.width = 15, fig.height = 8.5}
# New cases by state by day, log scale, with week long trend line
# use log scale otherwhise NY and MA overwhelm other states
CDC_w_trendline %>% #filter(State == "OK") %>%
  ggplot(aes(x = Date, y = total_cases_by_day)) +
  geom_point(size = 1, alpha = .5) + 
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  facet_wrap(~ State, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Total Cases By Day") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")

  )
```

## Hospitalizations By State

```{r hospitalizations,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
covid_tracking_data %>% 
  filter(State %in% state.abb) %>%
  mutate( Day = lubridate::yday(Date),
          Week =  lubridate::week(Date)) %>%
  #select(Date, Day, Week,hospitalizedCurrently) %>% 
  arrange(Date) %>%
  mutate(smooth_hospital = ksmooth(Day, hospitalizedCurrently, kernel = "normal", bandwidth = 7)$y) %>%
  ggplot(aes(x = Date, y = hospitalizedCurrently)) +
  geom_point(size = 1, alpha = .5) + 
  geom_line(aes(Date, smooth_hospital), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  facet_wrap(~ State, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Currently Hospitalized Patients") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")

  )

```

## Week to Week Changes in COVID Cases

```{r week-to-week,echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# Week-to-week percentage change in cases: (new week - prior week) / prior week
CDC_w_trendline  %>% 
  group_by(State, Week) %>%
  dplyr::summarise(new_cases_per_week = sum(new_cases, na.rm = T)) %>%
  mutate(
    last_week = lag(new_cases_per_week, 1),
    pct_change = (new_cases_per_week - last_week)/last_week , 
    week_to_date = lubridate::ymd( "2020-01-01" ) + lubridate::weeks(Week - 1 ),
    moving_average = zoo::rollmean(new_cases_per_week,4,align='right',fill=NA),
    pct_change_month = (new_cases_per_week - moving_average)/moving_average) %>%   
  #replace(is.na(.), 0)  %>% 
  group_by(State) %>%
  filter(Week > 10) %>%
  ggplot(aes(x = week_to_date, y = pct_change)) + 
  geom_point(aes(colour = cut(pct_change, c(-Inf, 0, Inf))),
             size = 1, alpha = 1) +
  scale_color_manual(name = "Cases",
                     values = c("(-Inf,0]" = "darkblue",
                                "(0, Inf]" = "red"),
                     labels = c("Falling","Rising")) +
  #geom_line(alpha = 0.3) +
  scale_y_continuous(label = scales::percent_format(accuracy = 1)) +
  facet_wrap(~ State) + #, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Change in New Cases from Prior Week") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold"),
    legend.position = "none"
  ) +
  coord_cartesian(ylim = c(-0.25,0.25)) +
  geom_hline(yintercept=0, color = "black", linetype = "dashed", size=1) 

```

## Cases as a Percentage of State Population
```{r, echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 8.5}
# Total cases by state, as a percentage of state population
CDC_w_trendline %>% #filter(State == "AK") %>%
  left_join(population_data_by_state, by = "State") %>%
  mutate(cases_as_pct_of_pop = total_cases_by_day/population) %>%
  ggplot(aes(x = Date, y = cases_as_pct_of_pop)) +
  geom_point(size = 1, alpha = .5) + #color = "grey"
  #geom_line(aes(Date, smooth_total), color="darkblue") +
  scale_y_continuous(label = scales::percent_format(accuracy = 0.1)) +
  facet_wrap(~ State) + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Cases as % of State Population") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")

  )


```

## Northeast Cases By Month
```{r New Northeast, echo = F, warning = F,cache = F, message = F, fig.width = 11, fig.height = 8.5}
#Plot New England on the first of each month
usmap::plot_usmap("counties", labels = F, include = c(.northeast_region), color = "black",
                  data = CDC_total %>%
                    filter(Date > "2020-02-01" & 
                    State %in% .northeast_region &
                    (grepl("-01$", Date)) &
                      countyFIPS > 10 ) %>%
  dplyr::rename(fips = countyFIPS, 
                abbr = State), 
                  values = "Cases") + 
  scale_fill_continuous(low = "blue", high = "red",name = "Covid Cases", label = scales::comma) + #trans = "log10",
  theme(legend.position = "right") + 
  facet_wrap(~ Date)  + 
  theme_void() + xlab("") + ylab("") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=14, face="bold")
  )

```


## Cases By State Over Time

```{r,, echo = F, warning = F,cache = F, message = F, fig.width = 11, fig.height = 8.5}
# Cases over time
plot_usmap(data = CDC_total %>% 
             dplyr::rename(state = State) %>%
             filter(Date > "2020-02-01" & 
                      grepl("-01$", Date)) %>%
             group_by(state, Date) %>%
             summarise(Cases = sum(Cases, na.rm = T)), values = "Cases", color = "black") + 
  scale_fill_continuous(low = "blue", high = "red",name = "Covid Cases", label = scales::comma) +
  theme(legend.position = "right") + 
  facet_wrap(~ Date) + 
  theme_void() + xlab("") + ylab("") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=14, face="bold")
  )
```


## Deaths By State Over Time

```{r deaths by state,  echo = F, warning = F,cache = F, message = F, fig.width = 11, fig.height = 8.5}
plot_usmap(data = CDC_total %>% 
             dplyr::rename(state = State) %>%
             filter(Date > "2020-02-01" & 
                      grepl("-01$", Date)) %>%
             group_by(state, Date) %>%
             summarise(Deaths = sum(Deaths, na.rm = T)), values = "Deaths", color = "black") + 
  scale_fill_continuous(low = "blue", high = "red",name = "Covid Deaths", label = scales::comma) +
  theme(legend.position = "right") + 
  facet_wrap(~ Date) + 
  theme_void() + xlab("") + ylab("") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=14, face="bold")
    )


```

## Positive Tests Over Negative Tests in the Last Two Weeks

```{r ratio, echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 10}
covid_tracking_data %>% 
  filter(State %in% state.abb) %>%
  mutate( Day = lubridate::yday(Date),
          Week =  lubridate::week(Date),
          ratio = positive/negative) %>%
  arrange(Date) %>%
  mutate(smooth_ratio = ksmooth(Day, ratio, kernel = "normal", bandwidth = 7)$y) %>%
  filter(Week > max(Week) - 2) %>%
  ggplot(aes(x = Date, y = ratio)) +
  geom_point(size = 1, alpha = .5) + 
  #geom_line(aes(Date, smooth_ratio), color="darkblue") +
  scale_y_continuous(label = scales::percent_format(accuracy = 0.1)) +
  facet_wrap(~ State) + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Ratio of Positive to Negative Tests") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
  )

```

## Currently Hospitalized Patients

```{r icu, echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 10}
covid_tracking_data %>% 
  filter(State %in% state.abb) %>%
  mutate( Day = lubridate::yday(Date),
          Week =  lubridate::week(Date)) %>%
  arrange(Date) %>%
  mutate(smooth_ICU = ksmooth(Day, inIcuCurrently, kernel = "normal", bandwidth = 7)$y) %>%
  ggplot(aes(x = Date, y = inIcuCurrently)) +
  geom_point(size = 1, alpha = .5) + 
  geom_line(aes(Date, smooth_ICU), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  facet_wrap(~ State, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Currently Hospitalized Patients in the ICU") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")
  )
```

## Patients Currently on Ventilators 

```{r vent, echo = F, warning = F,cache = F, message = F, fig.width = 13, fig.height = 10}
covid_tracking_data %>% 
  filter(State %in% state.abb) %>%
  mutate( Day = lubridate::yday(Date),
          Week =  lubridate::week(Date)) %>%
  arrange(Date) %>%
  mutate(smooth_ICU = ksmooth(Day, onVentilatorCurrently, kernel = "normal", bandwidth = 7)$y) %>%
  ggplot(aes(x = Date, y = onVentilatorCurrently)) +
  geom_point(size = 1, alpha = .5) + 
  geom_line(aes(Date, smooth_ICU), color="darkblue") +
  scale_y_continuous(label = scales::number_format(accuracy = 1)) +
  facet_wrap(~ State, scales = "free") + # free scales scales each state individually
  theme_minimal() +
  xlab("Date") + ylab("Currently on Ventilator") +
  theme(
    plot.title = element_text(size=14, face="bold"),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=10, face="bold")
  )

```

## Different Counts from Different Data

See the difference between <https://covidtracking.com/api/v1/states/daily.csv> and <https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/>

```{r differences, echo = F, warning = F,cache = F, message = F, fig.width = 11, fig.height = 8.5}
covid_tracker <- covid_tracking_data_w_trendline  %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date) %>%
  replace(is.na(.), 0) %>%
  summarise(total_cases_by_day = sum(positive, na.rm = T),
            total_deaths_by_day = sum(death, na.rm = T)) %>%
  ggplot(aes(x = Date, y = total_cases_by_day)) +
  geom_point(size = 1, alpha = .5) + 
  geom_point(mapping = aes(x = Date, y = total_deaths_by_day),
             size = 1, alpha = .5, shape = 2, color = "darkred") +
  theme_minimal() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Total Cases/Deaths") + 
  ggtitle(c(paste("Covidtracking.com Through",max(covid_tracking_data_w_trendline$Date)))) + 
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")

  )

### Overall Cases in USA ###
CDC <- CDC_w_trendline %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date) %>%
  summarise(total_cases_by_day = sum(total_cases_by_day),
            total_deaths_by_day = sum(total_deaths_by_day)) %>%
  ggplot(aes(x = Date, y = total_cases_by_day)) +
  geom_point(size = 1, alpha = .5) +
  geom_point(mapping = aes(x = Date, y = total_deaths_by_day),
             size = 1, alpha = .5, shape = 2, color = "darkred") +
  theme_minimal() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Total Cases/Deaths") +
  ggtitle(c(paste("CDC Through", as.Date(max(CDC_w_trendline$Date))))) +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )


merge_covid_tracker <- covid_tracking_data_w_trendline  %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date) %>%
  replace(is.na(.), 0) %>%
  summarise(CT_total_cases_by_day = sum(positive, na.rm = T),
            CT_total_deaths_by_day = sum(death, na.rm = T))

merge_CDC <- CDC_w_trendline  %>%
  ungroup() %>% #filter(State %in% c("MA","NY") & Week > 20) %>%
  group_by(Date) %>%
  replace(is.na(.), 0) %>%
  summarise(CDC_total_cases_by_day = sum(total_cases_by_day, na.rm = T),
            CDC_total_deaths_by_day = sum(total_deaths_by_day, na.rm = T))

difference_in_counts <- merge(merge_CDC, merge_covid_tracker, by = c("Date"))

difference_in_counts <- difference_in_counts %>% 
  select(Date, CDC_total_cases_by_day, CT_total_cases_by_day, 
         CDC_total_deaths_by_day, CT_total_deaths_by_day) %>%
  mutate(case_difference = CDC_total_cases_by_day - CT_total_cases_by_day, 
         death_difference = CDC_total_deaths_by_day - CT_total_deaths_by_day)

difference_plot <- difference_in_counts %>%
  ggplot(aes(x = Date, y = case_difference)) +
  geom_point(size = 1, alpha = .5) + 
  geom_point(mapping = aes(x = Date, y = death_difference),
             size = 1, alpha = .5, shape = 2, color = "darkred") +
  theme_minimal() +
  scale_y_continuous(label = scales::comma) +
  xlab("Date") + ylab("Difference in US Cases/Deaths") + 
  ggtitle("CDC Minus Covidtracking.com") +
  theme(
    plot.title = element_text(size=14, face="bold",hjust = 0.5),
    axis.title.x = element_text(size=14, face="bold"),
    axis.title.y = element_text(size=14, face="bold"),
    strip.text.x = element_text(size=10, face="bold"),
    axis.text = element_text(size=14, face="bold")
  )

#### Show Data is Different ####
grid.arrange(CDC, covid_tracker, difference_plot, nrow = 1)

```



